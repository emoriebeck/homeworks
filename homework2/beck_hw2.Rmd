---
title: "Homework 2"
author: "Emorie Beck"
date: \today
output: 
  pdf_document:
    toc: yes
    includes:
            in_header:
                header.tex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

# Workspace

## Packages
```{r packages, results='hide'}
library(psych)
library(lme4)
library(knitr)
library(kableExtra)
library(plyr)
library(tidyverse)
```

## Data
```{r data}
data_url <- "https://raw.githubusercontent.com/emoriebeck/homeworks/master/homeowrk2/HSB.csv"
dat      <- read.csv(url(data_url)) %>% tbl_df
```

## Local Functions
```{r funs}
table_fun <- function(model){
  fixed <- broom::tidy(model) %>% filter(group == "fixed") %>%
    select(term, estimate) 
  ## add random effects ##
  rand <- VarCorr(model)[[1]]
  rand <- rand[1:nrow(rand), 1:nrow(rand)]
  colnames(rand)[colnames(rand) == "(Intercept)"] <- "Intercept"
  rownames(rand)[rownames(rand) == "(Intercept)"] <- "Intercept"
  vars <- rownames(rand)
  rand[upper.tri(rand)] <- NA
  rand <- data.frame(rand) %>% mutate(var1 = rownames(.)) %>%
    gather(key = var2, value = estimate, -var1, na.rm = T) %>%
    mutate(var1 = mapvalues(var1, vars, 0:(length(vars)-1)),
           var2 = mapvalues(var2, vars, 0:(length(vars)-1))) %>%
    filter(var1 == var2) %>%
    unite(var, var1, var2, sep = "") %>%
    mutate(var = sprintf("$\\tau_{%s}$", var))
  ## get confidence intervals ##
  CI <- data.frame(confint.merMod(model, method = "boot", nsim = 10, oldNames = F)) %>%
    mutate(term = rownames(.)) %>% setNames(c("lower", "upper", "term"))
  
  CI %>% filter(term == "sigma") %>%
    mutate(estimate = sigma(model),
           term = "$\\sigma^2$",
           type = "Residuals")
  
  ## Get ICC & R2 values ##
  ICC <- reghelper::ICC(model)
  R2 <- MuMIn::r.squaredGLMM(model)
  
  ## format the fixed effects
  fixed <- fixed %>% left_join(CI %>% filter(!grepl(".sig", term))) %>%
    mutate(type = "Fixed Parts")
  
  rand <- rand %>%
    left_join(
      CI %>% filter(grepl("sd", term)) %>%
        mutate(lower = lower^2, upper = upper^2,
               var = mapvalues(term, unique(term), 0:(length(unique(term))-1)),
               var = sprintf("$\\tau_{%s%s}$", var, var)) %>% select(-term)) %>%
    mutate(type = "Random Parts") %>% rename(term = var)
  
  mod_terms <- tribble(
    ~term, ~estimate, ~type,
    # "ICC", ICC, "Model Terms",
    "$R^2_m$", R2[1], "Model Terms",
    "$R^2_c$", R2[2], "Model Terms"
  )
  
  tab <- fixed %>%
    full_join(rand) %>%
    mutate(CI = sprintf("[%.2f, %.2f]", lower, upper)) %>%
    select(-lower, -upper) %>%
    full_join(mod_terms) %>%
    mutate(estimate = sprintf("%.2f", estimate)) %>%
    dplyr::rename(b = estimate) %>%
    select(type, everything())
  return(tab)
}
```


# Question 1 
Begin by testing the fully unconditional model:
$$mathach_{ij} = \beta_0 + r_{ij}$$
$$\beta_0 = \gamma_{00} + u_{0j}$$
Calculate the intraclass correlation to determine how much of the variance in math achievement resides at Level 2 (the school level).  

```{r}
lmerICC <- function(obj) {
  v <- as.data.frame(VarCorr(obj))
  v$vcov[1]/sum(v$vcov)
}

mod0 <- lmer(mathach ~ 1 + (1 | School), data = dat)
lmerICC(mod0)
```

# Question 2
Modify the model to include student minority status (minority: 1=minority, 0=other): 
$$mathach_{ij} = \beta_{0j} + \beta_{1j}minority_{ij} + r_{ij}$$
$$\beta_{0j} = \gamma_{00} + u_{0j}$$
$$\beta_{1j} = \gamma_{10} + u_{1j}$$

```{r Q2, results = 'asis'}
mod1  <- lmer(mathach ~ minority + (minority | School), data = dat)
tidy1 <- broom::tidy(mod1)
tab   <- table_fun(mod1)

options(knitr.kable.NA = '')
tab %>% 
  kable(., "latex", escape = F, booktabs = T,
        col.names = c("type", "Term", "b", "CI")) %>%
  collapse_rows(1)
```

## Part A
a) Is math achievement significantly related to minority status? 

## Part B
(b) What is the expected (mean) level of math achievement for non-minority students? 


## Part C
(c) What is the expected (mean) level of math achievement for minority students? 

## Part D
(d) How much Level 1 variance is accounted for by this model compared to the fully unconditional model? 

# Question 3
Now add student sex (female: male=0, female=1) and group-centered SES to the Level 1 model:  
$$mathach_{ij} = \beta_{0j} + \beta_{1j}minority_{ij} + \beta_{2j}female_{ij} + \beta_{3j}(ses_{ij}-meanses_{j}) + r_{ij}$$
$$\beta_{0j} = \gamma_{00} + u_{0j}$$
$$\beta_{1j} = \gamma_{10} + u_{1j}$$
$$\beta_{2j} = \gamma_{20} + u_{2j}$$
$$\beta_{3j} = \gamma_{30} + u_{3j}$$

```{r Q3, results = 'asis'}
dat <- dat %>%
  mutate(GC.ses = ses - meanses)

mod2  <- lmer(mathach ~ minority + female + GC.ses + (minority + female + GC.ses | School), data = dat)
tidy2 <- broom::tidy(mod2)
tab2  <- table_fun(mod2)

tab2 %>% 
  kable(., "latex", escape = F, booktabs = T,
        col.names = c("type", "Term", "b", "CI")) %>%
  collapse_rows(1)
```

## Part a
(a) Is there a significant sex difference in math achievement, controlling for minority status and SES? 
Yes, females have lower math achievement than males, controlling for SES and minority status, $\gamma_{20} = `r (tab2 %>% filter(term == "female"))$b`$. 
## Part b 
(b) Is the effect of student-level SES significant?  Explain how the coefficient for this effect ($\beta_{3j}$) should be interpreted.  
Controlling for gender and minority status, a one unit increase in SES is associated with a $`r (tab2 %>% filter(term == "GC.ses"))$b`$ increase in math achievement.  
## Part c
(c) What is the expected (mean) level of math achievement for minority male students with SES equal to their school average?  
$Y_{ij} = \gamma_{00} + \gamma_{10}*1 + \gamma_{20}*0 + \gamma_{30}*0$  
$Y_{ij} = \gamma_{00} + \gamma_{10}$
$Y_{ij} = `r (tab2 %>% filter(term == "(Intercept)"))$b` + `r (tab2 %>% filter(term == "minority"))$b`$
$Y_{ij} = `r round((tidy2 %>% filter(term == "(Intercept)"))$estimate + (tidy2 %>% filter(term == "minority"))$estimate, 2)`$

## Part d
(d) How much Level 1 variance is accounted for by this model compared to the fully unconditional model?  
`r round(sigma(mod2)*100,2)`\% of the variance is accounted for by the fully conditional model.  

## Part e 
(e) Does this model provide a significantly better fit than the previous model?  
```{r 3e}
(c1 <- anova(mod1, mod2))
```

Yes, the deviance of the model that includes gender and SES have smaller deviance than the model that does not, $\chi^2(9) = `r round(c1$Chisq[2],2)`$, $p<.001$.  

## Part f
(f) Explain why there are 9 degrees of freedom for the $\chi^2$ test in the previous question.   
The smaller model (that did not include gender and SES) had 6 degrees of freedom, while the larger model had 15 degrees of freedom. The deviance test we conducted is $\chi^2$ distributed with degrees of freedom equal to the degrees of freedom of the larger minus the smaller model.  

# Question 4
Now add sector (1=Catholic, 0=Public) to the model:  
$$mathach_{ij} = \beta_{0j} + \beta_{1j}minority_{ij} + \beta_{2j}female_{ij} + \beta_{3j}(ses_{ij}-meanses_{j}) + r_{ij}$$
$$\beta_{0j} = \gamma_{00} + \gamma{01}sector_j + u_{0j}$$
$$\beta_{1j} = \gamma_{10} + \gamma{11}sector_j + u_{1j}$$
$$\beta_{2j} = \gamma_{20} + \gamma{21}sector_j + u_{2j}$$
$$\beta_{3j} = \gamma_{30} + \gamma{31}sector_j + u_{3j}$$

## Part a 
Does sector significantly predict the Level 1 intercepts ($\beta_{0j}$)?  If so, provide an interpretation of the relationship. 

## Part b
Does sector significantly predict the Level 1 slope for minority ($\beta_{1j}$)?  If so, provide an interpretation of the relationship. 

## Part c 
Does sector significantly predict the Level 1 slope for ses ($\beta_{3j}$)?  If so, provide an interpretation of the relationship. 

## Part d
How much Level 2 variance is accounted for by this model compared to the model (Question 3) that does not contain sector?  Note that this will require calculating four values, one for each of the four Level 2 equations.  You will find something unusual when you do this; comment on why you think the odd result is occurring.   

## Part e
Does this model provide a significantly better fit than the previous model?  